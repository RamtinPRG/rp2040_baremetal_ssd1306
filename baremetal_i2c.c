#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "pico/stdlib.h"
#include "hardware/i2c.h"

// I2C defines
// This example will use I2C0 on GPIO8 (SDA) and GPIO9 (SCL) running at 400KHz.
// Pins can be changed, see the GPIO function select table in the datasheet for information on GPIO assignments
#define I2C_PORT i2c0
#define I2C_SDA 12
#define I2C_SCL 13

#define SSD1306_ADDR 0x3C

#define BUF_LEN (64u / 8u) * 128u

uint8_t image[] = {
    // 'test', 128x64px
    0x00, 0x40, 0x10, 0x04, 0x40, 0x09, 0x96, 0x20, 0x48, 0x80, 0x53, 0x04, 0xaa, 0x15, 0x60, 0x86,
    0x28, 0x55, 0xa0, 0x05, 0x5a, 0x24, 0xd1, 0x2e, 0xd1, 0x2e, 0xd1, 0x2e, 0x41, 0xa8, 0x02, 0xa4,
    0x10, 0xe2, 0x04, 0xb9, 0x02, 0xf8, 0x0b, 0xf6, 0x4d, 0xb3, 0xde, 0xf1, 0xaf, 0x5c, 0xf3, 0x5e,
    0xa5, 0x5a, 0xf7, 0x48, 0xb7, 0x5a, 0xe5, 0x1a, 0xed, 0xb2, 0x4f, 0xb4, 0x49, 0x16, 0x40, 0x02,
    0x08, 0x00, 0x00, 0x08, 0x40, 0x04, 0x20, 0x00, 0x8a, 0x20, 0x05, 0x48, 0x14, 0x40, 0x90, 0x68,
    0x80, 0x28, 0xc0, 0x10, 0x40, 0x08, 0xc0, 0x00, 0x80, 0x00, 0x10, 0x22, 0x84, 0x29, 0x12, 0x89,
    0x04, 0x2b, 0x00, 0x05, 0x1b, 0x22, 0x00, 0x08, 0x80, 0x04, 0x00, 0x20, 0x02, 0x80, 0x24, 0x81,
    0x3a, 0xe7, 0x5d, 0x72, 0x5f, 0xb5, 0xeb, 0x5e, 0xb5, 0xbe, 0x65, 0x58, 0x22, 0x50, 0x20, 0x0a,
    0x41, 0x81, 0x28, 0x43, 0x08, 0x82, 0x10, 0x05, 0xa0, 0x0c, 0x11, 0xa4, 0x91, 0x05, 0x22, 0x48,
    0x13, 0x34, 0x4a, 0x35, 0x00, 0x6d, 0x00, 0xa5, 0x0a, 0x21, 0x8e, 0x31, 0xc6, 0x29, 0x90, 0x02,
    0xb4, 0x4b, 0x94, 0x29, 0x44, 0x91, 0x2e, 0xd5, 0x5b, 0xb6, 0xed, 0x16, 0xfd, 0xc3, 0xbe, 0x69,
    0xb7, 0x5a, 0xed, 0x97, 0x7a, 0xa5, 0xda, 0x37, 0xda, 0xb5, 0x44, 0x81, 0x42, 0x00, 0x00, 0x00,
    0x82, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x01, 0x00, 0x02, 0x20, 0x02, 0x00,
    0x04, 0x21, 0x02, 0x14, 0x02, 0x14, 0x01, 0x08, 0x02, 0x08, 0x02, 0x2d, 0x00, 0x94, 0x01, 0x20,
    0x00, 0x08, 0x20, 0x80, 0x24, 0x81, 0x22, 0x88, 0x40, 0x00, 0x00, 0x01, 0x00, 0x00, 0x80, 0x72,
    0x09, 0xce, 0xd1, 0x0a, 0x70, 0xc0, 0x12, 0xc8, 0x84, 0x50, 0x80, 0x21, 0x04, 0x10, 0x41, 0x8a,
    0x40, 0x84, 0x28, 0x81, 0x0a, 0x60, 0x84, 0x00, 0x02, 0x90, 0x01, 0x24, 0x0a, 0xa0, 0x02, 0x88,
    0x21, 0x10, 0x06, 0x49, 0xb2, 0x05, 0xa8, 0x00, 0xa2, 0x18, 0x42, 0x09, 0x12, 0x04, 0x00, 0x83,
    0x04, 0x08, 0x17, 0x40, 0x15, 0xe8, 0x03, 0xfe, 0x51, 0xae, 0x75, 0xcf, 0xba, 0x6b, 0xd6, 0xb9,
    0x4f, 0xb9, 0x46, 0xbd, 0x52, 0xad, 0x76, 0x8d, 0x7b, 0xc4, 0xbf, 0x20, 0xdf, 0x20, 0x1d, 0x42,
    0x94, 0x22, 0x82, 0x2c, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x00, 0x00, 0x00, 0x08, 0x40, 0x00, 0x92, 0x00, 0x00,
    0x00, 0x10, 0x02, 0x00, 0x12, 0x00, 0x81, 0x14, 0x00, 0x95, 0x00, 0xa0, 0x80, 0x58, 0xf7, 0x48,
    0x01, 0xbe, 0x4b, 0x15, 0x3e, 0x44, 0x49, 0x12, 0x01, 0x0c, 0x40, 0x00, 0x2a, 0x81, 0x10, 0x04,
    0x41, 0x94, 0x0a, 0x20, 0x48, 0x12, 0x44, 0x89, 0x24, 0x80, 0x22, 0x40, 0x88, 0x00, 0x23, 0x08,
    0x44, 0x10, 0x01, 0x24, 0x01, 0x48, 0x12, 0x45, 0x1c, 0x00, 0x08, 0x81, 0x00, 0x40, 0x10, 0x00,
    0x00, 0x10, 0x00, 0x08, 0x51, 0x26, 0x59, 0xa6, 0x5d, 0x2a, 0x57, 0x8a, 0x8d, 0x57, 0xa8, 0x63,
    0x81, 0x02, 0x0d, 0x13, 0x2c, 0x53, 0x6d, 0x9b, 0x24, 0x5b, 0x04, 0x13, 0x0c, 0x61, 0x02, 0xa8,
    0x00, 0x0f, 0xf0, 0x00, 0x04, 0x00, 0x08, 0x72, 0x89, 0x00, 0x80, 0x10, 0x80, 0x02, 0x20, 0x08,
    0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x08, 0x41, 0x84, 0x60, 0x58, 0xc4, 0x20, 0x00,
    0x00, 0x08, 0x01, 0x40, 0x08, 0x02, 0x00, 0x00, 0x00, 0x24, 0x8a, 0x10, 0x45, 0x22, 0x8d, 0x15,
    0xa2, 0x05, 0x69, 0x42, 0x95, 0x01, 0x04, 0xa1, 0x40, 0x09, 0x50, 0x02, 0x82, 0x10, 0x84, 0x02,
    0x42, 0x10, 0x20, 0x06, 0x10, 0x45, 0x10, 0x40, 0x12, 0x22, 0x44, 0x8b, 0x20, 0x85, 0x29, 0x00,
    0x45, 0x80, 0x14, 0x81, 0x04, 0x01, 0x00, 0x02, 0x00, 0x05, 0x01, 0x80, 0x03, 0x00, 0x01, 0x88,
    0x01, 0x08, 0x10, 0x07, 0x50, 0x08, 0x28, 0x12, 0xa4, 0x0b, 0x10, 0x09, 0x12, 0x4c, 0x01, 0x2e,
    0x11, 0x0a, 0x22, 0x08, 0x00, 0x41, 0x00, 0x25, 0x02, 0x01, 0x00, 0x00, 0x09, 0xa2, 0x44, 0x28,
    0x50, 0x84, 0x20, 0x56, 0x00, 0x00, 0x00, 0x01, 0x6e, 0x90, 0x2a, 0xd4, 0x22, 0x08, 0x05, 0x00,
    0x00, 0x00, 0x00, 0x40, 0x10, 0x04, 0x80, 0x10, 0xa4, 0x0a, 0x15, 0x43, 0x00, 0x02, 0x10, 0x00,
    0x80, 0x08, 0x00, 0x40, 0x02, 0x10, 0x80, 0x04, 0x01, 0x00, 0x50, 0x04, 0x89, 0x22, 0x84, 0x11,
    0x46, 0x50, 0x05, 0x22, 0x24, 0x89, 0x12, 0xa4, 0x09, 0x00, 0x82, 0x28, 0x40, 0x0a, 0x80, 0x14,
    0x55, 0x00, 0x24, 0x89, 0x22, 0x00, 0x15, 0x40, 0x15, 0x00, 0x95, 0x00, 0x22, 0x08, 0x82, 0x29,
    0x00, 0x02, 0x20, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x10, 0x82, 0x04, 0x28, 0x80, 0x08, 0x02, 0x48, 0x05,
    0x00, 0x92, 0x00, 0x54, 0x00, 0x14, 0x40, 0x10, 0x80, 0x50, 0x00, 0x00, 0x40, 0x12, 0x04, 0x40,
    0x12, 0x44, 0x10, 0x25, 0x84, 0x20, 0x00, 0x04, 0x20, 0x83, 0x00, 0x49, 0x00, 0x44, 0x00, 0x22,
    0x00, 0x10, 0x45, 0x00, 0x81, 0x08, 0x60, 0x80, 0x42, 0x10, 0xa0, 0x02, 0x20, 0x80, 0x21, 0x00,
    0x40, 0x04, 0x00, 0x10, 0x44, 0xa8, 0x80, 0x14, 0x20, 0x00, 0x08, 0x22, 0x40, 0x0a, 0xd4, 0x00,
    0x69, 0x02, 0x48, 0x17, 0x40, 0x22, 0x00, 0x48, 0x80, 0x01, 0xa8, 0x00, 0xa0, 0x12, 0x00, 0x80,
    0x00, 0x02, 0x20, 0x04, 0x00, 0x41, 0x08, 0x02, 0x00, 0x80, 0x10, 0x00, 0x04, 0x00, 0x80, 0x00,
    0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x40, 0x14, 0x81, 0x08, 0x04, 0x49,
    0x12, 0x14, 0xa0, 0x4e, 0x20, 0x11, 0x88, 0x22, 0x00, 0x10, 0x81, 0x08, 0x01, 0x20, 0x04, 0x81,
    0x28, 0x01, 0x4d, 0x20, 0x54, 0x80, 0x29, 0x50, 0x82, 0x34, 0xea, 0x10, 0x15, 0x40, 0x0a, 0x50,
    0x05, 0x12, 0x01, 0x00, 0x48, 0x01, 0x02, 0x4c, 0x84, 0x20, 0x00, 0x10, 0x82, 0x04, 0x20, 0x01,
    0x04, 0xa0, 0x01, 0x88, 0x00, 0x04, 0x20, 0x00, 0x49, 0x00, 0x10, 0x41, 0x08, 0x41, 0x10, 0x82,
    0x10, 0x45, 0x00, 0x12, 0x80, 0x25, 0x00, 0xaa, 0x10, 0x45, 0x00, 0x52, 0x80, 0x5d, 0x00, 0x52,
    0x82, 0x80, 0x00, 0x40, 0x84, 0x20, 0x80, 0x00, 0x88, 0x80, 0x00, 0x80, 0x88, 0x00, 0x80, 0x80,
    0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x20,
    0xc8, 0x02, 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x82, 0x00, 0xd0, 0x41, 0x82,
    0x28, 0x80, 0x88, 0x04, 0xa0, 0x00, 0xa0, 0x04, 0x80, 0x80, 0x28, 0x80, 0x00, 0x89, 0x80, 0x20,
    0x88, 0x81, 0x20, 0x95, 0x00, 0xc2, 0x09, 0x82, 0x01, 0x8a, 0x00, 0x92, 0x04, 0x91, 0x00, 0x81,
    0x00, 0xc0, 0x00, 0x80, 0x40, 0x04, 0x80, 0x20, 0x84, 0x80, 0x82, 0x20, 0x80, 0x10, 0x82, 0x80,
    0x00, 0xca, 0x00, 0x88, 0x82, 0x88, 0x05, 0xa0, 0x80, 0x14, 0xa1, 0x88, 0x22, 0x80, 0x48, 0x80,
    0x2a, 0xc0, 0x08, 0xa2, 0x00, 0x98, 0x02, 0xd4, 0x00, 0x95, 0x81, 0x28, 0x42, 0x95, 0xa0, 0x14};

void send_ssd1306_cmd(uint8_t cmd)
{
    uint8_t buf[] = {0x80, cmd};
    i2c_write_blocking(I2C_PORT, SSD1306_ADDR, buf, 2, false);
}

void send_ssd1306_cmd_list(uint8_t *cmd_list, int len)
{
    for (int i = 0; i < len; i++)
        send_ssd1306_cmd(cmd_list[i]);
}

void send_ssd1306_buf(uint8_t *buf, int len)
{
    uint8_t *temp = malloc(len + 1);

    temp[0] = 0b01000000;
    memcpy(temp + 1, buf, len);
    i2c_write_blocking(i2c_default, SSD1306_ADDR, temp, len + 1, false);

    free(temp);
}

void render(uint8_t *buf, uint8_t col_start, uint8_t col_end, uint8_t page_start, uint8_t page_end)
{
    // update a portion of the display with a render area
    uint8_t cmds[] = {
        0x21,
        col_start,
        col_end,
        0x22,
        page_start,
        page_end,
    };

    send_ssd1306_cmd_list(cmds, count_of(cmds));
    send_ssd1306_buf(buf, (col_end - col_start + 1) * (page_end - page_start + 1));
}

int main()
{
    stdio_init_all();

    // I2C Initialisation. Using it at 400Khz.
    i2c_init(I2C_PORT, 400 * 1000);

    gpio_set_function(I2C_SDA, GPIO_FUNC_I2C);
    gpio_set_function(I2C_SCL, GPIO_FUNC_I2C);
    gpio_pull_up(I2C_SDA);
    gpio_pull_up(I2C_SCL);
    // For more examples of I2C use see https://github.com/raspberrypi/pico-examples/tree/master/i2c

    uint8_t init_sequence[] = {
        0xAE, // display off
        0xA8, // set mux ratio
        0x3F, // 63
        0xD3, // display offset
        0x00, // 0
        0x40, // display start line = 0
        0xA1, // default segment remap
        0xC8, // com output scan direction
        0x20, // addressing mode
        0x00, // horizontal addressing mode
        0xDA, // com pins hardware config
        0x12, // refer to datasheet
        0x81, // set contrast control
        0x7F, // 127
        0xA4, // disable entire display on
        0xA6, // set normal display
        0xD5, // set osciallator freq
        0x80, // 128
        0x8D, // enable charge pump
        0x14,
        0xAF, // diplay on
    };

    send_ssd1306_cmd_list(init_sequence, count_of(init_sequence));

    uint8_t *black = malloc(BUF_LEN);
    memset(black, 0, BUF_LEN);
    render(image, 0, 127, 0, 7);
}
