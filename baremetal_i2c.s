/* ============================================================
 *  Register / Constant Definitions
 * ============================================================ */

.equ rst_clr,        0x4000f000      // Atomic register for clearing reset controller (2.1.2)
.equ rst_base,       0x4000c000      // Reset controller base (2.14.3)

.equ gpio12_ctrl,    0x40014064      // GPIO12_CTRL (2.19.6.1)
.equ gpio13_ctrl,    0x4001406c      // GPIO13_CTRL (2.19.6.1)

.equ pad12_ctrl,     0x4001c034      // PADS_BANK0 for GPIO12 (2.19.6.3)
.equ pad13_ctrl,     0x4001c038      // PADS_BANK0 for GPIO13 (2.19.6.3)

.equ i2c0_base,      0x40044000      // I2C0 base address (4.3.17)
.equ ic_data_cmd,    0x10            // IC_DATA_CMD offset
.equ ic_status,      0x70            // IC_STATUS offset

.equ tfnt_bit,       (1 << 1)        // TX FIFO not full - IC_STATUS
.equ mst_act_bit,    (1 << 5)        // Master activity - IC_STATUS

.equ cmd_restart,    (1 << 10)       // RESTART bit - IC_DATA_CMD
.equ cmd_stop,       (1 << 9)        // STOP bit - IC_DATA_CMD

.equ buffer_length,  (8 * 128)       // Pages × columns


.syntax unified
.cpu cortex-m0plus
.thumb



.section .text
.global main
.thumb_func
.type main, %function

main:
    bl  stdio_init_all               // Initialize stdio for debugging purposes (SDK function)

    /* --- Release I2C0 from reset --- */
    ldr r0, =rst_clr
    movs r1, #8                      // Bit 3 = I2C0
    str r1, [r0]

    /* --- Wait for reset completion --- */
rst:
    ldr  r0, =rst_base
    ldr  r1, [r0, #8]                // RESET_DONE
    movs r2, #8
    ands r1, r1, r2
    beq  rst

    /* --- Select I2C function on GPIO12 / GPIO13 --- */
    ldr  r0, =gpio12_ctrl
    movs r1, #3
    str  r1, [r0]

    ldr  r0, =gpio13_ctrl
    str  r1, [r0]

    /* --- Enable pull-ups, disable pull-downs --- */
    ldr  r0, =pad12_ctrl
    movs r1, #8
    ldr  r2, =0x2000
    adds r2, r0
    str  r1, [r2]

    movs r1, #4
    ldr  r2, =0x3000
    adds r2, r0
    str  r1, [r2]

    ldr  r0, =pad13_ctrl
    movs r1, #8
    ldr  r2, =0x2000
    adds r2, r0
    str  r1, [r2]

    movs r1, #4
    ldr  r2, =0x3000
    adds r2, r0
    str  r1, [r2]

    /* --- Initialize I2C0 (master mode) --- */
    ldr  r0, =i2c0_base

    movs r1, #0
    str  r1, [r0, #0x6C]             // IC_ENABLE = 0

    ldr  r1, =0x165                  // 1 0110 0101
    str  r1, [r0]                    // IC_CON

    movs r1, #0
    str  r1, [r0, #0x3C]             // IC_TX_TL
    str  r1, [r0, #0x38]             // IC_RX_TL

    movs r1, #3
    movs r2, #0x88
    str  r1, [r0, r2]                // IC_DMA_CR

    /* --- I2C Fast-mode timing (≈400 kHz, demo values) --- */
    /****** NOTE ******
	I didn't calculate the values exactly. But since it doesn't really affect
	the functionality of this code I didn't bother to do so. It's just a demo
	******************/
    ldr  r1, =67
    str  r1, [r0, #0x1C]             // IC_FS_SCL_HCNT

    ldr  r1, =161
    str  r1, [r0, #0x20]             // IC_FS_SCL_LCNT

    ldr  r1, =10
    movs r2, #0xA0
    str  r1, [r0, r2]                // IC_FS_SPKLEN

    ldr  r1, =40
    str  r1, [r0, #0x7C]             // IC_SDA_HOLD

    /* --- Target slave address (SSD1306) --- */
    ldr  r1, =0x3C
    str  r1, [r0, #0x04]             // IC_TAR

    /* --- Enable I2C --- */
    movs r1, #1
    str  r1, [r0, #0x6C]

    /* --- Send SSD1306 init sequence --- */
    ldr  r0, =init_sequence
    movs r1, #21
    bl   send_ssd1306_cmd_list

    /* --- Send display buffer --- */
    ldr  r0, =buffer
    ldr  r1, =buffer_length
    bl   send_ssd1306_buffer

program_finished:
    b program_finished


/* ============================================================
 *  I2C Write Buffer
 *  params:
 *    r0 = buf address
 *    r1 = buf length
 * ============================================================ */

.thumb_func
i2c_write_buf:
    push {r4, r5, r6, r7, lr}

    mov  r4, r0                      // Buffer pointer
    mov  r5, r1                      // Length
    ldr  r6, =i2c0_base

    cmp  r5, #0
    beq  i2c_done

/* --- First byte (RESTART) --- */
wait_first:
    ldr  r0, [r6, #ic_status]
    ldr  r7, =tfnt_bit
    tst  r0, r7
    beq  wait_first

    ldrb r0, [r4]
    adds r4, #1
    str  r0, [r6, #ic_data_cmd]
    subs r5, #1

/* --- Middle bytes --- */
tx_loop:
    cmp  r5, #1
    ble  tx_last

wait_mid:
    ldr  r0, [r6, #ic_status]
    ldr  r7, =tfnt_bit
    tst  r0, r7
    beq  wait_mid

    ldrb r0, [r4]
    adds r4, #1
    str  r0, [r6, #ic_data_cmd]
    subs r5, #1
    b    tx_loop

/* --- Last byte (STOP) --- */
tx_last:
    cmp  r5, #0
    beq  wait_done

wait_last:
    ldr  r0, [r6, #ic_status]
    ldr  r7, =tfnt_bit
    tst  r0, r7
    beq  wait_last

    ldrb r0, [r4]
    ldr  r7, =cmd_stop
    orrs r0, r0, r7
    str  r0, [r6, #ic_data_cmd]

/* --- Wait for bus idle --- */
wait_done:
    ldr  r0, [r6, #ic_status]
    ldr  r7, =mst_act_bit
    tst  r0, r7
    bne  wait_done

i2c_done:
    pop {r4, r5, r6, r7, pc}


/* ============================================================
 *  SSD1306 Helpers
 * ============================================================ */

.thumb_func
send_ssd1306_cmd:
    push {r4, lr}

    sub  sp, #4
    add  r4, sp, #0
    /*
    According to datasheet section 8.1.5.2 a control byte should be sent
    as the first byte of the transmition to determine if the next bytes 
    are commands or data. If commands, the control byte should be set to
    0x80.
    */
    movs r2, #0x80                   // Control byte (command)
    strb r2, [r4]
    strb r0, [r4, #1]

    movs r0, r4
    movs r1, #2
    bl   i2c_write_buf

    add  sp, #4
    pop  {r4, pc}


.thumb_func
send_ssd1306_cmd_list:
    push {r4, r5, lr}

    mov  r4, r0                      // List pointer
    mov  r5, r1                      // Length

cmd_list_loop:
    cmp  r5, #0
    ble  cmd_list_done

    ldrb r0, [r4]
    adds r4, #1
    bl   send_ssd1306_cmd

    subs r5, #1
    b    cmd_list_loop

cmd_list_done:
    pop  {r4, r5, pc}


.thumb_func
send_ssd1306_buffer:
    push {r4, r5, lr}

    movs r4, r0                      // Buffer
    movs r5, r1                      // Length

    sub  sp, #8
    add  r3, sp, #0

    movs r2, #0x21                   // Set column address
    strb r2, [r3]
    movs r2, #0
    strb r2, [r3, #1]
    movs r2, #127
    strb r2, [r3, #2]

    movs r2, #0x22                   // Set page address
    strb r2, [r3, #3]
    movs r2, #0
    strb r2, [r3, #4]
    movs r2, #7
    strb r2, [r3, #5]

    movs r0, r3
    movs r1, #6
    bl   send_ssd1306_cmd_list

    add  sp, #8

    movs r0, r4
    adds r1, r5, #1
    bl   i2c_write_buf

    pop  {r4, r5, pc}


/* ============================================================
 *  Data
 * ============================================================ */

.data
// Refer to datasheet -> application note -> Section 3: Software Configuration
init_sequence:
    .byte 0xAE, 0xA8, 0x3F, 0xD3, 0x00, 0x40, 0xA1, 0xC8
    .byte 0x20, 0x00, 0xDA, 0x12, 0x81, 0x7F, 0xA4, 0xA6
    .byte 0xD5, 0x80, 0x8D, 0x14, 0xAF

// Nerd Emoji
buffer:
    .byte 0x40                       // Data control byte
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00
    .byte 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80
    .byte 0x60, 0xd0, 0xa0, 0xf8, 0xd4, 0x78, 0xf6, 0xdc, 0x7a, 0xef, 0x7a, 0xdd, 0xff, 0xd6, 0x7d, 0xdf
    .byte 0xf5, 0x5f, 0xfd, 0xf7, 0x5e, 0xfb, 0x6e, 0xfa, 0xdc, 0x76, 0xe8, 0xfc, 0x50, 0xe8, 0xd0, 0xa0
    .byte 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x98, 0xf4, 0xab, 0x7e, 0x75
    .byte 0x1f, 0x3d, 0x37, 0x1e, 0x3b, 0x2f, 0x3d, 0x37, 0x3f, 0x2d, 0x7f, 0x5b, 0x7e, 0xd7, 0x7f, 0xf5
    .byte 0xdf, 0x7f, 0xf5, 0x5f, 0x77, 0x7d, 0x1f, 0x37, 0x3d, 0x2f, 0x3d, 0x37, 0x1d, 0x3f, 0x36, 0x1f
    .byte 0x75, 0x7e, 0xb5, 0x6a, 0xd8, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x32, 0xef, 0xb5, 0xdc, 0x80, 0x00, 0xfc
    .byte 0x5e, 0xf5, 0x7f, 0xdd, 0xb7, 0xff, 0x85, 0x23, 0x09, 0x53, 0x02, 0xfe, 0xbc, 0x00, 0xc0, 0xb0
    .byte 0xf0, 0x80, 0x00, 0xfe, 0x5e, 0xa2, 0x09, 0x53, 0x01, 0x97, 0x7d, 0xef, 0xbd, 0xf7, 0x5e, 0xfe
    .byte 0x74, 0x00, 0x80, 0xdc, 0x7b, 0xd6, 0x6d, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0xd3, 0xbe, 0x55, 0xff, 0x56, 0xec, 0x78
    .byte 0xd3, 0xe7, 0xa5, 0xef, 0x2a, 0xe7, 0xad, 0xce, 0xeb, 0xa6, 0xf3, 0x53, 0xf8, 0xae, 0x7b, 0xd6
    .byte 0xbd, 0xef, 0xba, 0x68, 0xf3, 0x57, 0xe2, 0xae, 0xe7, 0xad, 0xe7, 0xad, 0x6e, 0xc3, 0xf5, 0xa3
    .byte 0xf9, 0x54, 0xff, 0xb5, 0x6f, 0x9a, 0x77, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x2f, 0x59, 0xaf, 0x7b
    .byte 0xae, 0xdb, 0x76, 0xdf, 0x75, 0xdc, 0x79, 0xd4, 0xb3, 0xe2, 0x77, 0xc5, 0x7b, 0xf6, 0x7b, 0xf7
    .byte 0x76, 0xf5, 0xf7, 0x35, 0xeb, 0xb7, 0x62, 0xf3, 0x50, 0xfd, 0xd4, 0xbf, 0xf5, 0xae, 0xfb, 0xae
    .byte 0x5b, 0xf7, 0x1a, 0x2d, 0x0b, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01
    .byte 0x02, 0x05, 0x03, 0x0d, 0x17, 0x09, 0x1f, 0x36, 0x0d, 0x3b, 0x6f, 0x5a, 0x2f, 0x75, 0x5f, 0xaa
    .byte 0x7f, 0x55, 0x3e, 0x57, 0x2d, 0x77, 0x5d, 0x2b, 0x37, 0x0a, 0x1f, 0x02, 0x0d, 0x06, 0x01, 0x02
    .byte 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
